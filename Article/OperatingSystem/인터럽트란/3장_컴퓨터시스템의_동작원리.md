# 컴퓨터 시스템의 동작 원리


## 컴퓨터 시스템의 구조

![1-1]

컴퓨터 내의 각 하드웨어 장치에는 __컨트롤러(controller)__ 가 붙어있습니다. 컴퓨터 전체에 CPU가 있듯이 컨트롤러는 일종의 작은 CPU로서, 각 하드웨어 장치마다 존재하면서 이들을 제어하는 작은 CPU라고 할 수 있습니다. 예를 들어 메모리를 제어하는 컨트롤러는 메모리 컨트롤러이고, 디스크를 제어하는 컨트롤러는 디스크 컨트롤러입니다.

운영체제는 컴퓨터가 부팅되었을 때부터 항상 수행되면서 각종 자원들을 관리해야 하므로 항상 메모리에 올라가 있습니다. 이 때, 운영체제의 코드가 매우 크기 때문에 모든 코드를 다 메모리에 상주시키면 메모리의 낭비가 심합니다. 따라서, 운영체제의 일부만 메모리에 올립니다. 항상 메모리에 올라가는 운영체제 일부 영역을 __커널(kernal)__ 이라고 합니다.  


각 장치마다 제어하기 위해 설치된 장치 컨트롤러에는 장치로부터 들어오고 나가는 데이터를 임시로 저장하기 위한 작은 메모리를 가지고 있고 이를 __로컬버퍼__ 라고 합니다.

디스크나 키보드 등에서 데이터를 읽어오는 경우, 로컬 버퍼에 데이터가 임시로 저장된 후 메모리에 전달됩니다. 이 때, 장치에서 로컬 버퍼로 읽어오는 일은 컨트롤러가 담당합니다. 예를 들어 프로그램이 수행중에, 디스크에서 데이터를 읽어오라는 명령을 내리면 디스크 컨트롤러가 물리적인 디스크에서 내용을 읽어 이를 로컬 버퍼에 저장합니다. 원하는 데이터를 로컬 버퍼로 다 읽어오고 나면 B는 자신이 필요한 데이터를 다 읽어왔으므로 컨트롤러가 __인터럽트__ 를 발생시켜 CPU에 보고합니다.  



## 인터럽트

__인터럽트__ 란 컨트롤러들이 CPU의 서비스가 필요할 때 이를 통보하는 방법을 말합니다. 기본적으로 CPU는 매 시험 메모리에서 명령을 하나씩 읽어와서 수행합니다. 이 때, CPU 옆에는 __인터럽트 라인__ 이 있어서, CPU가 명령어를 하나 수행하면 인터럽트가 발생하는지 체크합니다. 인터럽트 라인에 신호가 들어오면 하던 일을 멈추고, 인터럽트와 관련된 일을 처리합니다. 


// 하드웨어 인터럽트, 소프트웨어 인터럽트

인터럽트는 하드웨어 인터럽트와 소프트웨어 인터럽트로 나눌 수 있습니다. 
__하드웨어 인터럽트__ 란 각종 하드웨어 장치들이 CPU에게 서비스를 받아야 하는 경우에 발생합니다. 이는 인터럽트 라인을 통해 CPU에게 전달됩니다. 
__소프트웨어 인터럽트__ 란 __트랩__ 이라고도 하며 프로그램이 수행되다가 접근해서는 안되는 메모리 영역을 침범하려는 경우, 0으로 나누는 연산 등을 시도한 경우 등 예외 상황이나 시스템 콜 시에 소프트웨어적으로 발생되는 인터럽트를 의미합니다. 소프트웨어 인터럽트는 프로그램이 잘못된 연산을 수행한 경우 그것에 대해 적절한 처리를 위해 사용되는 __예외 상황 처리__ 와 __시스템 콜__ 로 나뉘어 집니다.  

인터럽트가 발생하면 CPU는 하던 일을 멈추고 인터럽트를 처리하기 위한 루틴(운영체제 커널 코드)에 들어가서 정의된 일을 찾게 됩니다.

__인터럽트 벡터(interrupt vector)__ 란 인터럽트 종류마다 번호를 정해서, 번호에 따라 저리해야할 코드가 위치한 부분을 포인터로 가리키고 있는 자료구조입니다. 실제 처리해야 할 내용은 __인터럽트 서비스 루틴(interrupt service routine)__ 에 정의되어 있습니다.


*참고. 
- 함수 호출: 자신이 작성한 함수 혹은 라이브러리에 정의된 함수를 호출
- 시스템 콜: 운영체제에 정의된 함수를 호출하는 것으로 일종의 인터럽트 메커니즘으로 동작


우리가 사용하는 운영체제는 여러 프로그램이 동시에 실행될 수 있는 다중 프로그래밍 환경에서 동작합니다. 그러므로 각 프로그램들이 다른 프로그램의 실행을 방해하거나 프로그램 간에 서로 충돌을 일으키는 문제를 막기 위해 하드웨어에 각종 보안 기법이 필요합니다. 하드웨어 보안을 유지하기 위해서 운영체제는 __커널 모드(kernal mode)__ 와 __사용자 모드(user mode)__  두 가지 모드의 오퍼레이션을 지원합니다. 


<p align="center">
    <img src="img/userkenal.PNG?raw=true" width="60%" />
</p>

<p> Figure. 모든 종류의 명령어를 실행할 수 있는 커널 모드와 다르게 유저모드는 I/O, 레지스터 접근 명령어 등의 명령어는 실행할 수 없습니다.  </p>


__커널 모드__ 는 운영체제가 CPU의 제어권을 가지고 운영체제 코드를 실행하는 모드로서, 이 모드에서는 모든 종류의 명령을 다 실행할 수 있습니다. __유저 모드__ 에서는 일반 사용자 프로그램이 실행되며 제한적인 명령만 수행할 수 있습니다. 

컴퓨터 시스템은 CPU 내부에 모드 비트(mode bit)를 두어 사용자 프로그램을 감시하게 됩니다. 모드 비트가 0으로 세팅되어 있으면 커널 모드로서 모든 명령을 수행할 수 있고, 모드 비트가 1로 세팅되어 있으면 사용자 모드로서 제한된 명령만을 수행할 수 있습니다.  



- 참고자료
    - 운영체제와 정보 기술의 원리 (반효영 저)
    - Operating System Concepts, 9/E (Abraham Silberschatz 저)
- Figure 출처
    - Figure X. OLC Center Kernal of Linux (고건 교수) 19p


<br />
<br />

---------------------
광고 꽝고~~~